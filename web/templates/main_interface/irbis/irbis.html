{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div id="irbis-container">
    {% if error %}
    <div class="main-menu">
        <div class="menu-header">
            <span class="menu-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ Irbis</span>
            <span class="menu-label">{{ error }}</span>
        </div>
        <div class="menu-row single">
            <a href="{% url 'main_menu' %}" class="menu-btn back full">‚¨Ö –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</a>
        </div>
    </div>

    {% elif step == 'payment' %}
    <div class="main-menu">
        <div class="menu-header">
            <span class="menu-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ Irbis</span>
            <span class="menu-label">üí° –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–¥–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî <b>200 —Ä—É–±</b>.</span>
            <span class="menu-header-text">–û–ø–ª–∞—Ç–∏—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ.</span>
        </div>

        <div class="menu-row single">
            <a href="{{ payment_link }}" class="menu-btn full js-pay" target="_blank"
               data-params='{"step":"check_payment","user_id":"{{ user_id }}","payment_id":"{{ payment_id }}","payment_link":"{{ payment_link }}"}'>
               üí≥ –û–ø–ª–∞—Ç–∏—Ç—å 200 —Ä—É–±
            </a>
        </div>

        <div class="menu-row single">
            <a href="{% url 'main_menu' %}" class="menu-btn back full">‚¨Ö –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</a>
        </div>
    </div>

    {% elif step == 'check_payment' %}
    <div class="main-menu">
        <div class="menu-header">
            <span class="menu-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ Irbis</span>
            <span class="menu-label">–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É</span>
        </div>

        <div id="payment-status" data-payment-id="{{ payment_id }}" data-user-id="{{ user_id }}" class="menu-header-text" style="text-align: center; margin: 20px 0;">
            ‚è≥ –û–∂–∏–¥–∞–µ–º –æ–ø–ª–∞—Ç—ã...
        </div>

        <div class="menu-row single" style="margin-top:10px;">
            <a href="{% url 'main_menu' %}" class="menu-btn back full">‚¨Ö –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</a>
        </div>
    </div>

    {% elif step == 'select_type' %}
    <div class="main-menu">
        <div class="menu-header">
            <span class="menu-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ Irbis</span>
            <span class="menu-label">‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –î–æ—Å—Ç—É–ø –∫ IRBIS –æ—Ç–∫—Ä—ã—Ç.</span>
            <span class="menu-header-text">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–≥–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:</span>
        </div>

        <div class="menu-row single">
            <a href="#" class="menu-btn full js-next-step"
               data-params='{"step":"check_jur","user_id":"{{ user_id }}"}'>
               üè¢ –Æ—Ä. –ª–∏—Ü–æ
            </a>
        </div>

        <div class="menu-row single">
            <a href="#" class="menu-btn full js-next-step"
               data-params='{"step":"check_fiz","user_id":"{{ user_id }}"}'>
               üë§ –§–∏–∑. –ª–∏—Ü–æ
            </a>
        </div>

        <div class="menu-row single">
            <a href="#" class="menu-btn full js-next-step"
               data-params='{"step":"check_realty","user_id":"{{ user_id }}"}'>
               üè† –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
            </a>
        </div>

        <div class="menu-row single">
            <a href="{% url 'main_menu' %}" class="menu-btn back full">‚¨Ö –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</a>
        </div>
    </div>

    {% elif step == 'check_jur' %}
    <div class="main-menu">
        <div class="menu-header">
            <span class="menu-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ Irbis</span>
            <span class="menu-label">–ü—Ä–æ–≤–µ—Ä–∫–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞</span>
            <span class="menu-header-text">–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ:</span>
        </div>

        <div class="menu-row single">
            <a href="{{ form_url }}" class="menu-btn full" target="_blank">
               üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —é—Ä. –ª–∏—Ü–∞
            </a>
        </div>

        <div class="menu-row single">
            <a href="#" class="menu-btn back full js-next-step"
               data-params='{"step":"select_type","user_id":"{{ user_id }}"}'>
               ‚¨Ö –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    {% elif step == 'check_fiz' %}
    <div class="main-menu">
        <div class="menu-header">
            <span class="menu-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ Irbis</span>
            <span class="menu-label">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Ü–∞</span>
            <span class="menu-header-text">–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ:</span>
        </div>

        <div class="menu-row single">
            <a href="{{ form_url }}" class="menu-btn full" target="_blank">
               üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∏–∑. –ª–∏—Ü–∞
            </a>
        </div>

        <div class="menu-row single">
            <a href="#" class="menu-btn back full js-next-step"
               data-params='{"step":"select_type","user_id":"{{ user_id }}"}'>
               ‚¨Ö –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    {% elif step == 'check_realty' %}
    <div class="main-menu">
        <div class="menu-header">
            <span class="menu-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ Irbis</span>
            <span class="menu-label">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</span>
            <span class="menu-header-text">–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ:</span>
        </div>

        <div class="menu-row single">
            <a href="{{ form_url }}" class="menu-btn full" target="_blank">
               üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
            </a>
        </div>

        <div class="menu-row single">
            <a href="#" class="menu-btn back full js-next-step"
               data-params='{"step":"select_type","user_id":"{{ user_id }}"}'>
               ‚¨Ö –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    {% endif %}
</div>

<script>
let paymentCheckInterval = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–≥–∞ —á–µ—Ä–µ–∑ AJAX
function loadStep(params) {
    let url = "{% url 'irbis_menu' %}?" + new URLSearchParams(params).toString();
    fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
        .then(response => response.text())
        .then(html => {
            document.getElementById('irbis-container').innerHTML = html;

            // –µ—Å–ª–∏ —à–∞–≥ check_payment ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            const statusBlock = document.getElementById('payment-status');
            if (statusBlock && statusBlock.dataset.paymentId) {
                startPaymentCheck(statusBlock.dataset.paymentId);
            }
        })
        .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–≥–∞:", err));
}

// –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã
function startPaymentCheck(paymentId) {
    if (!paymentId) return;
    if (paymentCheckInterval) clearInterval(paymentCheckInterval);

    const statusBlock = document.getElementById('payment-status');
    if (!statusBlock) return;

    paymentCheckInterval = setInterval(() => {
        fetch(`/domosclub/irbis/payment_check/${paymentId}`, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(r => r.json())
            .then(data => {
                if (data.status === 1) {
                    clearInterval(paymentCheckInterval);
                    statusBlock.innerHTML = '<span style="color:green;font-weight:bold;">‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –î–æ—Å—Ç—É–ø –∫ IRBIS –æ—Ç–∫—Ä—ã—Ç.</span>';
                    // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
                    setTimeout(() => {
                        loadStep({step: 'select_type', user_id: statusBlock.dataset.userId || '{{ user_id }}'});
                    }, 2000);
                } else if (data.status === 0) {
                    statusBlock.innerHTML = '<span>‚è≥ –û–∂–∏–¥–∞–µ–º –æ–ø–ª–∞—Ç—ã...</span>';
                } else {
                    statusBlock.innerHTML = '<span style="color:red;">‚ùå –ü–ª–∞—Ç—ë–∂ –Ω–µ –ø—Ä–æ—à—ë–ª</span>';
                }
            })
            .catch(err => console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã:", err));
    }, 10000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
document.addEventListener('click', function(e) {
    const target = e.target.closest('.js-next-step');
    const payBtn = e.target.closest('.js-pay');

    // –æ–±—ã—á–Ω—ã–µ —à–∞–≥–∏
    if (target) {
        e.preventDefault();
        let params = {};
        if (target.dataset.params) {
            try { params = JSON.parse(target.dataset.params); }
            catch (err) { console.warn("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON", err); }
        }

        const container = target.closest('.main-menu');
        if (container) {
            container.querySelectorAll('input').forEach(input => {
                if (input.name && input.value.trim()) params[input.name] = input.value.trim();
            });
        }
        loadStep(params);
    }

    // –∫–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å"
    if (payBtn) {
        e.preventDefault();

        let params = {};
        if (payBtn.dataset.params) {
            try { params = JSON.parse(payBtn.dataset.params); }
            catch (err) { console.warn("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON", err); }
        }

        const paymentLink = payBtn.getAttribute("href");
        const paymentId = params.payment_id;

        // –æ—Ç–∫—Ä—ã—Ç—å –ø–ª–∞—Ç—ë–∂–∫—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
        if (paymentLink) window.open(paymentLink, "_blank");

        // –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ —à–∞–≥ check_payment
        params.step = "check_payment";
        loadStep(params);
    }
});
</script>
{% endblock %}

