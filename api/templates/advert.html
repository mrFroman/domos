<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã</title>
    <style>
        * { box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 720px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: left;
            color: #141417;
            margin: 0 0 24px 0;
        }

        p {
            text-align: left;
            color: #141417;
            margin: 0 0 24px 0;
        }

        label {
            display: inline-block;
            margin-top: 12px;
            font-weight: bold;
            color: #444;
        }

        input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 6px;
            transition: border-color 0.2s;
        }

        input:focus { outline: none; border-color: #4CAF50; }

        #total-container {
            margin-top: 25px;
            font-size: 20px;
            font-weight: bold;
            color: #222;
            text-align: right;
        }

        button {
            margin-top: 20px;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 17px;
            transition: background-color 0.2s;
        }

        button:hover { background-color: #45a049; }
        button:disabled {
            background-color: #999 !important;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã</h1>
        <p>–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–π –Ω–∞ –∫–∞–∂–¥–æ–º –ø–æ—Ä—Ç–∞–ª–µ. –ï—Å–ª–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–µ –Ω—É–∂–Ω—ã ‚Äî —É–∫–∞–∂–∏—Ç–µ "0".</p>

        <form id="advertDataForm">
            <label>–§–ò–û</label>
            <input type="text" name="full_name" required>

            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
            <div id="positions-container"></div>

            <div id="total-container">–ò—Ç–æ–≥–æ: 0 ‚ÇΩ</div>

            <input type="hidden" id="user_id" value="{{ user_id }}">
            <input type="hidden" id="token" value="{{ token }}">

            <button type="submit">–û–ø–ª–∞—Ç–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–∫–ª–∞–º—É</button>
        </form>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–π –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞
        const serverPositions = {{ positions | tojson | safe }};

        document.addEventListener('DOMContentLoaded', function() {
            loadPositions();
        });

        function loadPositions() {
            const container = document.getElementById('positions-container');
            container.innerHTML = '';

            if (serverPositions && serverPositions.length > 0) {
                serverPositions.forEach(position => {
                    addPositionField(position.name, position.key, position.price);
                });
                return;
            }

            fetch('/api/advert_positions')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.positions) {
                        data.positions.forEach(position => {
                            addPositionField(position.name, position.key, position.price);
                        });
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∑–∏—Ü–∏–π:', data.error);
                        loadDefaultPositions();
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–∑–∏—Ü–∏–π:', error);
                    loadDefaultPositions();
                });
        }

        function addPositionField(name, key, price) {
            const container = document.getElementById('positions-container');

            const label = document.createElement('label');
            label.textContent = name;

            const input = document.createElement('input');
            input.type = 'number';
            input.name = key;
            input.value = '0';
            input.min = '0';

            input.addEventListener('input', calculateTotal);

            container.appendChild(label);
            container.appendChild(input);
        }

        function loadDefaultPositions() {
            const defaultPositions = [
                { name: '–¶–ò–ê–ù (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ –∏ –ø—Ä–∏–≥–æ—Ä–æ–¥)', key: 'CIAN_city', price: 364 },
                { name: '–¶–ò–ê–ù (–∑–∞ –ø—Ä–µ–¥–µ–ª–æ–º –°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏)', key: 'CIAN_country', price: 364 },
                { name: '–ê–í–ò–¢–û –∫–≤–∞—Ä—Ç–∏—Ä—ã', key: 'AVITO_apartments', price: 226 },
                { name: '–ê–í–ò–¢–û –∑–∞–≥–æ—Ä–æ–¥–∫–∞', key: 'AVITO_country_house', price: 1232 },
                { name: '–ê–í–ò–¢–û –∫–æ–º–º–µ—Ä—Ü–∏—è', key: 'AVITO_commercial', price: 385 },
                { name: '–ê–í–ò–¢–û –ø–∞—Ä–∫–∏–Ω–≥', key: 'AVITO_parkings', price: 270 },
                { name: '–ê–í–ò–¢–û –∞—Ä–µ–Ω–¥–∞ –∫–≤–∞—Ä—Ç–∏—Ä', key: 'AVITO_rent_apartments', price: 226 },
                { name: '–Ø–Ω–¥–µ–∫—Å–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', key: 'yandex_realty', price: 66 },
                { name: '–£–ü–ù', key: 'UPN', price: 94 },
                { name: '–î–æ–º–ö–ª–∏–∫', key: 'DomClick', price: 110 },
                { name: '–Æ–ª–∞', key: 'ULA', price: 66 }
            ];

            defaultPositions.forEach(position => {
                addPositionField(position.name, position.key, position.price);
            });
        }

        function getPrices() {
            const prices = {};
            if (serverPositions && serverPositions.length > 0) {
                serverPositions.forEach(position => {
                    prices[position.key] = position.price;
                });
                return prices;
            }

            return {
                CIAN_city: 364,
                CIAN_country: 364,
                AVITO_apartments: 204,
                AVITO_country_house: 1110,
                AVITO_commercial: 343,
                AVITO_parkings: 231,
                AVITO_rent_apartments: 196,
                yandex_realty: 66,
                UPN: 94,
                DomClick: 165,
                ULA: 66
            };
        }

        const form = document.getElementById('advertDataForm');
        const totalContainer = document.getElementById('total-container');

        function calculateTotal() {
            const prices = getPrices();
            let total = 0;

            for (let key in prices) {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    const count = parseFloat(input.value) || 0;
                    total += count * prices[key];
                }
            }
            totalContainer.textContent = `–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ`;
        }

        setTimeout(calculateTotal, 30);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const button = form.querySelector('button[type="submit"]');
            const originalText = button.textContent;

            // –°–æ—Å—Ç–æ—è–Ω–∏–µ loading
            button.disabled = true;
            button.textContent = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...";
            button.style.backgroundColor = "#999";

        // üîπ 1Ô∏è‚É£ –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
        let formObj = {};
        try {
            const formData = new FormData(form);
            formData.forEach((v, k) => formObj[k] = v);

            const total_price = totalContainer.textContent.replace(/\D+/g, '');
            formObj.total_price = total_price;
        } catch (err) {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã: ' + err.message);
            console.error(err);
            button.disabled = false;
            button.textContent = originalText;
            button.style.backgroundColor = "#4CAF50";
            return;
        }

        // üîπ 2Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞—è–≤–∫—É —Å 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏
        let saveResult;
        const maxAttempts = 3;

        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
            try {
                const payload = {
                    user_id: document.getElementById('user_id').value,
                    token: document.getElementById('token').value,
                    data_json: JSON.stringify(formObj),
                    signal: 1
                };

                const saveRes = await fetch('/api/save_advert_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!saveRes.ok)
                    throw new Error(`HTTP ${saveRes.status} –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏`);

                saveResult = await saveRes.json();

                if (!saveResult.success)
                    throw new Error(saveResult.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö");

                // –ï—Å–ª–∏ –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ ‚Äî –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
                break;

            } catch (err) {
                console.warn(`–ü–æ–ø—ã—Ç–∫–∞ ${attempt} –Ω–µ —É–¥–∞–ª–∞—Å—å:`, err.message);

                if (attempt === maxAttempts) {
                    // –ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫: ' + err.message);
                    console.error(err);
                    button.disabled = false;
                    button.textContent = originalText;
                    button.style.backgroundColor = "#4CAF50";
                    return;
                }

                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—É–∑—É –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä:
                await new Promise(res => setTimeout(res, 500)); // 0.5 —Å–µ–∫
            }
        }


        // üîπ 3Ô∏è‚É£ –°–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç—ë–∂ —Å 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏
        const maxPayAttempts = 3;
        for (let attempt = 1; attempt <= maxPayAttempts; attempt++) {
            try {
                const payRes = await fetch('/api/create_advert_payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        price: formObj.total_price,
                        fullname: formObj.full_name,
                        description: "–û–ø–ª–∞—Ç–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–∫–ª–∞–º—É",
                        user_id: document.getElementById('user_id').value,
                        token: document.getElementById('token').value
                    })
                });

                if (!payRes.ok)
                    throw new Error(`HTTP ${payRes.status} –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞`);

                const payResult = await payRes.json();

                if (payResult.success && payResult.payment_url) {
                    // –£—Å–ø–µ—à–Ω–æ ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    window.location.href = payResult.payment_url;
                    break; // –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
                } else {
                    throw new Error(payResult.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂");
                }

            } catch (err) {
                console.warn(`–ü–æ–ø—ã—Ç–∫–∞ ${attempt} —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:`, err.message);

                if (attempt === maxPayAttempts) {
                    // –ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫: ' + err.message);
                    console.error(err);
                    button.disabled = false;
                    button.textContent = originalText;
                    button.style.backgroundColor = "#4CAF50";
                    return;
                }

                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
                await new Promise(res => setTimeout(res, 500)); // 0.5 —Å–µ–∫
            }
        }


        // üîπ –ï—Å–ª–∏ –≤—Å—ë —É—Å–ø–µ—à–Ω–æ
        button.disabled = false;
        button.textContent = originalText;
        button.style.backgroundColor = "#4CAF50";

        });
    </script>
</body>
</html>
